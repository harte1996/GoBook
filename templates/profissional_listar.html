{% extends "base_admin.html" %}

{% block title %}Listar Profissional{% endblock %}

{% block content %}

<h2 class="mb-4">Profissional Cadastrados</h2>

<!-- RESPONSIVO -->
<div class="table-responsive">

    <table class="table table-striped align-middle">
        <thead>
            <tr>
                <th>Foto</th>
                <th>Nome</th>
                <th class="d-none d-md-table-cell">Email</th>
                <th class="d-none d-md-table-cell">Serviços</th>
                <th>Ações</th>
            </tr>
        </thead>

        <tbody>
        {% for b in profissional%}
            <tr>

                <!-- FOTO -->
                <td style="width:80px">
                    {% if b.foto %}
                        <img src="{{ url_for('static', filename='uploads/' ~ b.foto) }}"
                             class="img-thumbnail"
                             width="70">
                    {% else %}
                        <span class="text-muted">Sem foto</span>
                    {% endif %}
                </td>

                <!-- NOME -->
                <td>
                    <strong>{{ b.nome }}</strong>
                </td>

                <!-- EMAIL (OCULTO NO MOBILE) -->
                <td class="d-none d-md-table-cell">
                    {{ b.email }}
                </td>

                <!-- SERVIÇOS (OCULTO NO MOBILE) -->
                <td class="d-none d-md-table-cell">
                    <ul class="list-unstyled small m-0">

                        {% for serv in b.servicos %}
                        <li class="mb-2 d-flex justify-content-between align-items-center flex-wrap gap-2">

                            <div>
                                <strong>{{ serv.nome }}</strong>
                                <div class="text-muted">
                                    R$ {{ "%.2f"|format(serv.preco) }}
                                </div>
                            </div>

                            <button class="btn btn-sm btn-outline-primary"
                                    onclick="abrirModalPreco(
                                        {{ b.id }},
                                        {{ serv.id }},
                                        '{{ serv.nome }}',
                                        '{{ serv.preco }}'
                                    )">
                                Alterar preço
                            </button>

                        </li>
                        {% endfor %}

                    </ul>
                </td>

                <!-- AÇÕES -->
                <td>
                    <div class="d-flex flex-wrap gap-2">
                        <a href="{{ url_for('cadastro.editar_profissional', id=b.id) }}"
                           class="btn btn-sm btn-warning">
                            Editar
                        </a>

                        <form action="{{ url_for('cadastro.excluir_profissional', id=b.id) }}"
                              method="POST"
                              onsubmit="return confirm('Tem certeza que deseja excluir este profissional?')">
                            <button class="btn btn-sm btn-danger">
                                Excluir
                            </button>
                        </form>
                    </div>
                </td>

            </tr>
        {% endfor %}
        </tbody>
    </table>

</div>

<!-- MODAL PARA ALTERAR PREÇO -->
<div class="modal fade" id="modalPreco" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Alterar preço do serviço</h5>
                <button type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <form id="formPreco">

                    <input type="hidden" id="profissional_id">
                    <input type="hidden" id="servico_id">

                    <div class="mb-3">
                        <label class="form-label">Serviço</label>
                        <input type="text"
                               class="form-control"
                               id="servico_nome"
                               readonly>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Novo preço</label>
                        <input type="number"
                               step="0.01"
                               class="form-control"
                               id="preco"
                               required>
                    </div>

                </form>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary"
                        data-bs-dismiss="modal">
                    Cancelar
                </button>
                <button class="btn btn-primary"
                        onclick="salvarPreco()">
                    Salvar
                </button>
            </div>

        </div>
    </div>
</div>

<script>
function abrirModalPreco(profissionalId, servicoId, nome, preco) {

    document.getElementById("profissional_id").value = profissionalId;
    document.getElementById("servico_id").value = servicoId;
    document.getElementById("servico_nome").value = nome;
    document.getElementById("preco").value = preco;

    const modal = new bootstrap.Modal(
        document.getElementById('modalPreco')
    );
    modal.show();
}

function salvarPreco() {

    const data = {
        profissional_id: document.getElementById("profissional_id").value,
        servico_id: document.getElementById("servico_id").value,
        preco: document.getElementById("preco").value
    };

    fetch("/alterar_preco", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(resp => {
        if (resp.status === "ok") {
            location.reload();
        } else {
            alert("Erro ao salvar preço.");
        }
    });
}
</script>

{% endblock %}
