{% extends "base_admin.html" %}
{% block title %}Meus Dados{% endblock %}

{% block content %}
<style>
    #username-feedback {
        display: block;
        margin-top: 5px;
        font-size: 12px;
    }

    button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .container {
        display: flex;
        justify-content: center;
        padding: 20px;
    }

    .card-form {
        width: 100%;
        max-width: 700px;
        background: #fff;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, .08);
    }

    h2 {
        margin-bottom: 20px;
    }

    h3 {
        margin: 30px 0 15px;
        border-bottom: 1px solid #eee;
        padding-bottom: 5px;
        color: #111827;
    }

    .form-group {
        margin-bottom: 15px;
    }

    label {
        display: block;
        font-weight: 600;
        margin-bottom: 5px;
        font-size: 14px;
    }

    input {
        width: 100%;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #ddd;
        font-size: 14px;
    }

    input:disabled {
        background: #f5f5f5;
        cursor: not-allowed;
    }

    .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }

    .btn-primary {
        background: #111827;
        color: #fff;
        border: none;
        padding: 14px;
        width: 100%;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        margin-top: 20px;
    }

    .btn-primary:hover {
        opacity: 0.9;
    }

    .hint {
        font-size: 12px;
        color: #6b7280;
        margin-top: 5px;
    }
</style>

<div class="container">
    <form method="POST" class="card-form">

        <h2>Dados Cadastrais</h2>

        <!-- DADOS PESSOAIS -->
        <h3>Informações Pessoais</h3>

        <div class="form-group">
            <label>Nome</label>
            <input type="text" name="nome" value="{{ usuario.nome }}" required>
        </div>

        <div class="grid-2">
            <div class="form-group">
                <label>Usuário</label>
                <input type="text" name="username" id="username" value="{{ usuario.username }}" required>
                <small id="username-feedback"></small>
            </div>

            <div class="form-group">
                <label>Telefone</label>
                <input type="text" name="telefone" value="{{ usuario.telefone }}">
            </div>
        </div>

        <div class="grid-2">
            <div class="form-group">
                <label>Email</label>
                <input type="email" value="{{ usuario.email }}" disabled>
            </div>

            <div class="form-group">
                <label>CPF</label>
                <input type="text" value="{{ usuario.cpf }}" disabled>
            </div>
        </div>

        <div class="grid-2">
            <div class="form-group">
                <label>Tipo de Conta</label>
                <input type="text" value="{{ usuario.role }}" disabled>
            </div>

            <div class="form-group">
                <label>Slug</label>
                <input type="text" value="{{ usuario.slug }}" disabled>
                <div class="hint">Este é o link público do seu perfil</div>
            </div>
        </div>

        <!-- ESTABELECIMENTO -->
        <h3>Estabelecimento</h3>

        <div class="grid-2">
            <div class="form-group">
                <label>Nome do Estabelecimento</label>
                <input type="text" value="{{ usuario.estabelecimento_nome or 'Não vinculado' }}" disabled>
            </div>

            <div class="form-group">
                <label>Telefone do Estabelecimento</label>
                <input type="text" value="{{ usuario.estabelecimento_telefone or '-' }}" disabled>
            </div>
        </div>

        <!-- SENHA -->
        <h3>Alterar Senha</h3>

        <div class="form-group">
            <label>Senha Atual</label>
            <input type="password" name="senha_atual" placeholder="Informe sua senha atual">
        </div>

        <div class="grid-2">
            <div class="form-group">
                <label>Nova Senha</label>
                <input type="password" name="nova_senha" placeholder="Nova senha">
            </div>

            <div class="form-group">
                <label>Confirmar Nova Senha</label>
                <input type="password" name="confirmar_senha" placeholder="Confirme a nova senha">
            </div>
        </div>

        <div class="hint">
            Preencha os campos acima somente se desejar alterar sua senha.
        </div>

        <button type="submit" class="btn-primary">
            Salvar Alterações
        </button>

    </form>
</div>

<script>
    const usernameInput = document.getElementById("username");
    const feedback = document.getElementById("username-feedback");
    const submitBtn = document.querySelector("button[type='submit']");

    let usernameValido = true;
    let timeout = null;

    usernameInput.addEventListener("input", () => {
        clearTimeout(timeout);

        timeout = setTimeout(() => {
            const username = usernameInput.value.trim();

            if (username.length < 3) {
                feedback.textContent = "Usuário muito curto";
                feedback.style.color = "orange";
                usernameValido = false;
                submitBtn.disabled = true;
                return;
            }

            fetch("{{ url_for('cadastro.validar_username') }}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ username })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.disponivel) {
                        feedback.textContent = "Usuário disponível ✔";
                        feedback.style.color = "green";
                        usernameValido = true;
                        submitBtn.disabled = false;
                    } else {
                        feedback.textContent = "Usuário já está em uso ✖";
                        feedback.style.color = "red";
                        usernameValido = false;
                        submitBtn.disabled = true;
                    }
                })
                .catch(() => {
                    feedback.textContent = "Erro ao validar usuário";
                    feedback.style.color = "red";
                    submitBtn.disabled = true;
                });

        }, 400); // debounce
    });
</script>

{% endblock %}