{% extends "base_admin.html" %}
{% block title %}Editar Profissional{% endblock %}

{% block content %}

<!-- CropperJS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<style>
    /* Modal Crop */
    #cropModal .modal-dialog {
        max-width: 90vw;
    }

    #cropModal .modal-content {
        height: 90vh;
    }

    #cropModal .modal-body {
        width: 100%;
    }

    #crop-image {
        max-width: 100%;
        max-height: 100%;
    }

    .cropper-container {
        width: 100% !important;
        height: 100% !important;
    }

    /* Preview */
    .preview-wrapper {
        margin-top: 20px;
        width: 180px;
        height: 240px; /* 3:4 */
        border-radius: 12px;
        border: 2px dashed #ced4da;
        background: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

    #preview-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
</style>

<h2 class="mb-4">Editar Profissional</h2>

<form method="POST" enctype="multipart/form-data">

    <!-- Nome -->
    <div class="mb-3">
        <label class="form-label">Nome</label>
        <input type="text" name="nome" class="form-control" value="{{ profissional.nome }}" required>
    </div>

    <!-- Email -->
    <div class="mb-3">
        <label class="form-label">Email</label>
        <input type="email" name="email" class="form-control" value="{{ profissional.email }}" required>
    </div>

    <!-- Email -->
    <div class="mb-3">
        <label class="form-label">Telefone</label>
        <input type="text" name="telefone" class="form-control" value="{{ profissional.telefone }}" required>
    </div>


    <!-- Serviços -->
    <div class="mb-4">
        <label class="form-label">Serviços oferecidos</label>
        <div class="row">

            {% for serv in todos_servicos %}
            <div class="col-md-6 mb-2">
                <div class="border rounded p-2">

                    <div>
                        <input type="checkbox"
                               class="form-check-input me-1"
                               name="servicos[]"
                               value="{{ serv.id }}"
                               {% if serv.id in servicos_do_profissional_ids %}checked{% endif %}>
                        <strong>{{ serv.nome }}</strong>
                    </div>

                    {% if serv.id in servicos_do_profissional_ids %}
                    <div class="mt-2 ms-4">
                        Preço atual:
                        <strong>R$ {{ "%.2f"|format(servicos_precos[serv.id]) }}</strong>

                        <button type="button"
                                class="btn btn-sm btn-outline-primary ms-2"
                                onclick="abrirModalPreco({{ profissional.id }}, {{ serv.id }}, '{{ serv.nome }}', '{{ servicos_precos[serv.id] }}')">
                            Alterar preço
                        </button>
                    </div>
                    {% endif %}

                </div>
            </div>
            {% endfor %}

        </div>
    </div>

    <!-- Foto -->
    <div class="mb-3">
        <label class="form-label">Foto do Profissional</label>
        <input type="file"
               class="form-control"
               name="foto"
               accept="image/*"
               id="foto-input">
    </div>

    <!-- Foto atual -->
    {% if profissional.foto %}
    <img id="foto-atual"
         src="{{ url_for('static', filename='uploads/' ~ profissional.foto) }}"
         width="150"
         class="img-thumbnail mb-3">
    {% endif %}

    <!-- Preview nova foto -->
    <div class="text-center">
        <div id="preview-wrapper" class="preview-wrapper d-none mx-auto">
            <img id="preview-img">
        </div>
    </div>

    <button class="btn btn-primary mt-4">Salvar Alterações</button>
</form>

<!-- MODAL PREÇO -->
<div class="modal fade" id="modalPreco" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Alterar preço do serviço</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <input type="hidden" id="profissional_id">
                <input type="hidden" id="servico_id">

                <div class="mb-3">
                    <label>Serviço</label>
                    <input type="text" class="form-control" id="servico_nome" readonly>
                </div>

                <div class="mb-3">
                    <label>Novo preço</label>
                    <input type="number" step="0.01" class="form-control" id="preco">
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarPreco()">Salvar</button>
            </div>

        </div>
    </div>
</div>

<!-- MODAL CROP -->
<div class="modal fade" id="cropModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-fullscreen-md-down">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Ajustar Foto</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body text-center">
                <img id="crop-image">
            </div>

            <div class="modal-footer">
                <button id="crop-btn" class="btn btn-primary">Aplicar Corte</button>
            </div>

        </div>
    </div>
</div>

<script>
let cropper;

const modalEl   = document.getElementById("cropModal");
const imgCrop   = document.getElementById("crop-image");
const fileInput = document.getElementById("foto-input");
const preview   = document.getElementById("preview-img");
const previewWrapper = document.getElementById("preview-wrapper");

const modal = new bootstrap.Modal(modalEl);

/* -------- PREÇO -------- */
function abrirModalPreco(profissionalId, servicoId, nome, preco) {
    document.getElementById("profissional_id").value = profissionalId;
    document.getElementById("servico_id").value = servicoId;
    document.getElementById("servico_nome").value = nome;
    document.getElementById("preco").value = preco;

    new bootstrap.Modal('#modalPreco').show();
}

function salvarPreco() {
    fetch("/alterar_preco", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            profissional_id: profissional_id.value,
            servico_id: servico_id.value,
            preco: preco.value
        })
    })
    .then(r => r.json())
    .then(resp => {
        if (resp.status === "ok") location.reload();
        else alert("Erro ao salvar preço");
    });
}

/* -------- FOTO -------- */
fileInput.addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;

    imgCrop.src = URL.createObjectURL(file);
    modal.show();
});

modalEl.addEventListener("shown.bs.modal", () => {
    if (cropper) cropper.destroy();

    cropper = new Cropper(imgCrop, {
        aspectRatio: 3 / 4,
        viewMode: 1,
        autoCropArea: 1,
        background: false
    });
});

document.getElementById("crop-btn").addEventListener("click", () => {

    const canvas = cropper.getCroppedCanvas({ width: 400, height: 533 });

    preview.src = canvas.toDataURL("image/jpeg");
    previewWrapper.classList.remove("d-none");

    const fotoAtual = document.getElementById("foto-atual");
    if (fotoAtual) fotoAtual.classList.add("d-none");

    canvas.toBlob(blob => {
        const file = new File([blob], "foto.jpg", { type: "image/jpeg" });
        const dt = new DataTransfer();
        dt.items.add(file);
        fileInput.files = dt.files;
    });

    modal.hide();
});
</script>

{% endblock %}
