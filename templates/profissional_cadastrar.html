{% extends "base_admin.html" %}

{% block title %}Cadastrar Barbeiro{% endblock %}

{% block content %}

<!-- CropperJS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<!-- Se já existir no base_admin.html, pode remover -->
<!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script> -->

<style>
    /* Modal grande */
    #cropModal .modal-dialog {
        max-width: 90vw;
    }

    #cropModal .modal-content {
        height: 90vh;
    }

    #cropModal .modal-body {
        width: 100%;
        max-width: 100%;
    }

    #crop-image {
        max-width: 100%;
        max-height: 100%;
        display: block;
    }

    .cropper-container {
        width: 100% !important;
        height: 100% !important;
    }

    .preview-wrapper {
    margin-top: 50px;
    width: 180px;
    height: 240px; /* proporção 3:4 */
    border-radius: 12px;
    border: 2px dashed #ced4da;
    overflow: hidden;
    background: #f8f9fa;
    display: flex;
    align-items: center;
    justify-content: center;
    }

    #preview-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .btn {
        margin-top: 50px;
    }

</style>

<div class="container mt-4">

    <h2>Cadastrar Barbeiro</h2>
    <hr>

    <form method="POST" enctype="multipart/form-data">

        <div class="mb-3">
            <label class="form-label">Nome do Barbeiro</label>
            <input type="text" class="form-control" name="nome" required>
        </div>

        <div class="mb-3">
            <label class="form-label">E-mail</label>
            <input type="email" class="form-control" name="email">
        </div>

        <!-- Serviços -->
        <div class="mb-3">
            <label class="form-label">Serviços oferecidos</label>

            <div class="row">
                {% for serv in servicos %}
                <div class="col-4 mb-2">
                    <input class="form-check-input"
                           type="checkbox"
                           name="servicos[]"
                           value="{{ serv.id }}"
                           id="serv{{ serv.id }}">
                    <label class="form-check-label" for="serv{{ serv.id }}">
                        {{ serv.nome }} — R$ {{ "%.2f"|format(serv.valor) }}
                    </label>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Foto -->
        <div class="mb-3">

            <label class="form-label">Foto do Barbeiro</label>
            <div class="row g-3 align-items-center">
                <div class="col-md-6">
                    <input type="file"
                        class="form-control"
                        name="foto"
                        accept="image/*"
                        id="foto-input">
                </div>
            </div>

            <!-- Preview embaixo -->
            <div class="row g-3">
                <div class="col-12 text-center">
                    <div id="preview-wrapper" class="preview-wrapper d-none">
                        <img id="preview-img">
                    </div>
                    <div >  </div>
                </div>
            </div>

        <button class="btn btn-primary">Cadastrar</button>

    </form>
</div>

<!-- Modal de Crop -->
<div class="modal fade" id="cropModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-fullscreen-md-down">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Ajustar Foto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <img id="crop-image">
            </div>

            <div class="modal-footer">
                <button type="button" id="crop-btn" class="btn btn-primary">
                    Aplicar Corte
                </button>
            </div>

        </div>
    </div>
</div>

<script>
    let cropper;

    const modalEl   = document.getElementById("cropModal");
    const imgCrop   = document.getElementById("crop-image");
    const fileInput = document.getElementById("foto-input");
    const preview   = document.getElementById("preview-img");

    const modal = new bootstrap.Modal(modalEl);

    // Selecionar imagem
    fileInput.addEventListener("change", function (e) {
        const file = e.target.files[0];
        if (!file) return;

        imgCrop.src = URL.createObjectURL(file);
        modal.show();
    });

    // Inicializar cropper quando modal abrir
    modalEl.addEventListener("shown.bs.modal", function () {

        if (cropper) {
            cropper.destroy();
            cropper = null;
        }

        cropper = new Cropper(imgCrop, {
            aspectRatio: 3 / 4,
            viewMode: 1,
            autoCropArea: 1,
            responsive: true,
            background: false,
        });

        setTimeout(() => cropper.resize(), 50);
    });

    // Aplicar corte
    document.getElementById("crop-btn").addEventListener("click", function () {

        const canvas = cropper.getCroppedCanvas({
            width: 400,
            height: 400,
        });

        preview.src = canvas.toDataURL("image/jpeg");
        document.getElementById("preview-wrapper").classList.remove("d-none");

        canvas.toBlob(function (blob) {
            const file = new File([blob], "foto_cortada.jpg", { type: "image/jpeg" });
            const dt = new DataTransfer();
            dt.items.add(file);
            fileInput.files = dt.files;
        });

        modal.hide();
    });
</script>

{% endblock %}
