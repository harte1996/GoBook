{% extends "base_admin.html" %}

{% block title %}Cadastrar Barbeiro{% endblock %}

{% block content %}

<!-- CropperJS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<style>
    /* Aumenta a área disponível no modal */
    .modal-body {
        display: block;
        max-width: 100%;
        width: 250px;
    }

    .modal-content {
        height: 90vh;
    }

    .crop-image {
        width: 600px !important;
        height: 600px !important;
        object-fit:cover !important;
    }

    .cropper-container {
        width: 100% !important;
        height: 100% !important;
    }
    
    .centered-and-cropped { object-fit: cover }


     /* Remove o fundo quadriculado
    .cropper-bg {
        background-image: none !important;
        background-color: #000 !important;
    } */

</style>

<div class="container mt-4">

    <h2>Cadastrar Barbeiro</h2>
    <hr>

    <form method="POST" enctype="multipart/form-data">

        <div class="mb-3">
            <label class="form-label">Nome do Barbeiro</label>
            <input type="text" class="form-control" name="nome" required>
        </div>

        <div class="mb-3">
            <label class="form-label">E-mail</label>
            <input type="email" class="form-control" name="email">
        </div>

        <!-- Lista dinâmica de serviços -->
        <div class="mb-3">
            <label class="form-label">Serviços oferecidos</label>

            <div class="row">
                {% for serv in servicos %}
                <div class="col-4 mb-2">
                    <input class="form-check-input" type="checkbox" name="servicos[]" value="{{ serv.id }}"
                        id="serv{{ serv.id }}">
                    <label class="form-check-label" for="serv{{ serv.id }}">
                        {{ serv.nome }} — R$ {{ "%.2f"|format(serv.valor) }}
                    </label>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Foto -->
        <div class="mb-3">
            <label class="form-label">Foto do Barbeiro</label>

            <div class="d-flex gap-3 align-items-start">
                <input type="file" class="form-control w-50" name="foto" accept="image/*" id="foto-input">

                <img id="preview-img" class="border rounded"
                    style="width:140px;height:140px;display:none;object-fit:cover;">
            </div>
        </div>

        <button class="btn btn-primary">Cadastrar</button>

    </form>

</div>


<!-- Modal de Crop -->
<div class="modal fade" id="cropModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-fullscreen-md-down">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Ajustar Foto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body p-0">
                <img id="crop-image">
            </div>

            <div class="modal-footer">
                <button type="button" id="crop-btn" class="btn btn-primary">
                    Aplicar Corte
                </button>
            </div>

        </div>
    </div>
</div>

<!-- JS DO CROP -->
<script>
    let cropper;

    // Ao selecionar imagem
    document.getElementById("foto-input").addEventListener("change", function (e) {
        const file = e.target.files[0];
        if (!file) return;

        const imgCrop = document.getElementById("crop-image");
        imgCrop.src = URL.createObjectURL(file);

        // Abre modal
        const modal = new bootstrap.Modal(document.getElementById("cropModal"));
        modal.show();

        // Inicializar cropper quando imagem carregar
        imgCrop.onload = function () {
            if (cropper) cropper.destroy();

            cropper = new Cropper(imgCrop, {
                aspectRatio: 3 / 4,
                viewMode:1,
                // dragMode: 'move',
                autoCropArea: 1,            // 100% da área visível
                responsive: true,
                // restore: false,
                // guides: false,
                // center: true,
                // highlight: false,
                // background: false,          // remove xadrez
                // movable: true,
                // zoomable: true,
                // scalable: false,
                // rotatable: false,
            });
        };
    });

    // Aplicar corte
    document.getElementById("crop-btn").addEventListener("click", function () {

        const canvas = cropper.getCroppedCanvas({
            width: 400,
            height: 400
        });

        // Preview
        const preview = document.getElementById("preview-img");
        preview.src = canvas.toDataURL("image/jpeg");
        preview.style.display = "block";

        // Substituir arquivo no input
        canvas.toBlob(function (blob) {
            const fileInput = document.getElementById("foto-input");
            const file = new File([blob], "foto_cortada.jpg", { type: "image/jpeg" });

            const dt = new DataTransfer();
            dt.items.add(file);
            fileInput.files = dt.files;
        });

        bootstrap.Modal.getInstance(document.getElementById("cropModal")).hide();
    });
</script>

{% endblock %}