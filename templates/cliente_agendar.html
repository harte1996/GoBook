<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Agendar Hor√°rio</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<style>
.card-select {
    cursor: pointer;
    transition: .2s;
    border: 2px solid transparent;
}
.card-select:hover {
    transform: scale(1.02);
}
.card-select.active {
    border-color: #198754;
}
.img-card {
    height: 200px;
    width: 150px;
    object-fit: cover;
}
.img-card-service {
    height: 160px;
    object-fit: cover;
}
.slot {
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 8px;
    cursor: pointer;
    text-align: center;
}
.slot.active {
    background: #198754;
    color: #fff;
    border-color: #198754;
}
</style>
</head>

<body class="bg-light">

<div class="container mt-4 mb-5">
    <h4 class="text-center mb-4">Agende seu hor√°rio</h4>

    <form id="form-agenda">

        <!-- üë§ Dados -->
        <input class="form-control mb-2" name="nome" placeholder="Seu nome" required>
        <input class="form-control mb-4" name="telefone" placeholder="WhatsApp" required>

        <!-- ‚úÇÔ∏è profissionals -->
        <h5>Escolha o profissional</h5>
        <div class="row mb-4">
            {% for b in profissional %}
            <div class="col-6 col-md-4 mb-3">
                <div class="card card-select profissional-card" data-id="{{ b.id }}" data-nome="{{ b.nome }}">
                    <img src="{{ url_for('static', filename='uploads/' ~ b.foto) }}" class="card-img-top img-card">
                    <div class="card-body text-center">
                        <strong>{{ b.nome }}</strong>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- üíº Servi√ßos -->

        <h5>Escolha o servi√ßo</h5>

        <div id="servicos-loading" class="text-center text-muted mb-3" style="display:none">
            Carregando servi√ßos...
        </div>

        <div id="servicos-area" class="row mb-4"></div>

        <!-- üìÖ Data -->
        <h5>Escolha a data</h5>
        <input type="date" class="form-control mb-4" id="data" name="data" required>

        <!-- ‚è∞ Hor√°rios -->
        <h5>Hor√°rios dispon√≠veis</h5>
        <div id="horarios" class="row g-2 mb-4"></div>

        <!-- Hidden -->
        <input type="hidden" name="profissional" id="profissional">
        <input type="hidden" name="servico" id="servico">
        <input type="hidden" name="horario" id="horario">
        <input type="hidden" name="profissional_nome" id="profissional_nome">
        <input type="hidden" name="servico_nome" id="servico_nome">

        <button class="btn btn-success w-100">Confirmar Agendamento</button>
    </form>
</div>


<script>
function carregarHorarios(){
    if($('#profissional').val() && $('#servico').val() && $('#data').val()){
        $.get('/client/horarios',{
            profissional: $('#profissional').val(),
            servico: $('#servico').val(),
            data: $('#data').val()
        }, function(res){
            $('#horarios').html(res)
        })
    }
}

// üëâ Sele√ß√£o do profissional
$('.profissional-card').click(function(){

    $('.profissional-card').removeClass('active')
    $(this).addClass('active')

    const profissionalId   = $(this).data('id')
    const profissionalNome = $(this).data('nome')

    $('#profissional').val(profissionalId)
    $('#profissional_nome').val(profissionalNome)

    // Reset
    $('#servico').val('')
    $('#horario').val('')
    $('#horarios').html('')
    $('#servicos-area').html('')
    $('#servicos-loading').show()

    // Buscar servi√ßos do profissional
    $.get(`/client/servicos/${profissionalId}`, function(res){
        $('#servicos-loading').hide()
        $('#servicos-area').html(res)
    })
})

// üëâ Sele√ß√£o do servi√ßo (delegado)
$(document).on('click', '.servico-card', function(){
    $('.servico-card').removeClass('active')
    $(this).addClass('active')

    $('#servico').val($(this).data('id'))
    $('#servico_nome').val($(this).data('nome'))

    $('#horario').val('')
    $('#horarios').html('')

    carregarHorarios()
})

// Data
$('#data').change(carregarHorarios)

// Hor√°rio
$(document).on('click', '.slot', function(e){
    e.preventDefault() // seguran√ßa extra

    $('.slot').removeClass('active')
    $(this).addClass('active')

    const hora = $(this).data('hora')
    $('#horario').val(hora)
})

// Submit
$('#form-agenda').submit(function(e){
    e.preventDefault()

    if(!$('#horario').val()){
        alert('Selecione um hor√°rio')
        return
    }

    $.post('/client/confirmar/', $(this).serialize(), function(res){
        window.location.href = res.redirect
    })
})
</script>

</body>
</html>
